rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ユーザー認証チェック
    function isAuthenticated() {
      return request.auth != null;
    }

    // ホワイトリスト登録済みユーザーかチェック
    function isWhitelisted() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // 管理者かチェック
    function isAdmin() {
      return isWhitelisted() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ドキュメント（書類管理）
    match /documents/{docId} {
      allow read: if isWhitelisted();
      // 作成: Cloud Functionsのみ（サービスアカウント経由、ルール適用外）
      allow create: if false;
      // 更新: 顧客解決・事業所解決フィールドのみ許可
      allow update: if isWhitelisted()
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          // 顧客解決フィールド（Phase 7）
          'customerId',
          'customerName',
          'customerConfirmed',
          'needsManualCustomerSelection',
          'confirmedBy',
          'confirmedAt',
          'isDuplicateCustomer',
          // 事業所解決フィールド
          'officeId',
          'officeName',
          'officeConfirmed',
          'officeConfirmedBy',
          'officeConfirmedAt'
        ])
        // confirmedBy は自分のUIDのみ設定可能
        && (request.resource.data.confirmedBy == request.auth.uid
            || request.resource.data.confirmedBy == resource.data.confirmedBy
            || request.resource.data.confirmedBy == null)
        // officeConfirmedBy は自分のUIDのみ設定可能
        && (request.resource.data.officeConfirmedBy == request.auth.uid
            || request.resource.data.officeConfirmedBy == resource.data.officeConfirmedBy
            || request.resource.data.officeConfirmedBy == null
            || !('officeConfirmedBy' in request.resource.data));
      allow delete: if isAdmin();
    }

    // 顧客解決監査ログ（Phase 7）
    match /customerResolutionLogs/{logId} {
      allow read: if isWhitelisted();
      // 作成: 認証済みユーザー、必須フィールドチェック
      allow create: if isWhitelisted()
        && request.resource.data.resolvedBy == request.auth.uid
        && request.resource.data.documentId is string
        && request.resource.data.documentId.size() > 0
        // newCustomerIdはstringまたはnull（該当なし選択時）
        && (request.resource.data.newCustomerId == null || request.resource.data.newCustomerId is string)
        && request.resource.data.newCustomerName is string
        && request.resource.data.newCustomerName.size() > 0
        && request.resource.data.resolvedByEmail is string
        && request.resource.data.resolvedAt is timestamp;
      // 更新・削除は禁止（監査ログは不変）
      allow update, delete: if false;
    }

    // 事業所解決監査ログ
    match /officeResolutionLogs/{logId} {
      allow read: if isWhitelisted();
      // 作成: 認証済みユーザー、必須フィールドチェック
      allow create: if isWhitelisted()
        && request.resource.data.resolvedBy == request.auth.uid
        && request.resource.data.documentId is string
        && request.resource.data.documentId.size() > 0
        // newOfficeIdはstringまたはnull（該当なし選択時）
        && (request.resource.data.newOfficeId == null || request.resource.data.newOfficeId is string)
        && request.resource.data.newOfficeName is string
        && request.resource.data.newOfficeName.size() > 0
        && request.resource.data.resolvedByEmail is string
        && request.resource.data.resolvedAt is timestamp;
      // 更新・削除は禁止（監査ログは不変）
      allow update, delete: if false;
    }

    // マスターデータ
    match /masters/{masterId}/items/{itemId} {
      allow read: if isWhitelisted();
      allow write: if isAdmin();
    }

    // エラー履歴
    match /errors/{errorId} {
      allow read: if isWhitelisted();
      allow write: if isAdmin();
    }

    // Gmail受信ログ
    match /gmailLogs/{logId} {
      allow read: if isWhitelisted();
      allow write: if false; // Cloud Functionsのみ
    }

    // ユーザー管理
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow read, write: if isAdmin();
    }

    // アプリ設定
    match /settings/{settingId} {
      allow read: if isWhitelisted();
      allow write: if isAdmin();
    }

    // Phase 8: ドキュメントグループ（サマリー集計）
    match /documentGroups/{groupId} {
      allow read: if isWhitelisted();
      // 書き込みはCloud Functionsのみ（onDocumentWriteトリガー）
      allow write: if false;
    }
  }
}
