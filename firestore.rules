rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ユーザー認証チェック
    function isAuthenticated() {
      return request.auth != null;
    }

    // ホワイトリスト登録済みユーザーかチェック
    function isWhitelisted() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // 管理者かチェック
    function isAdmin() {
      return isWhitelisted() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ドキュメント（書類管理）
    match /documents/{docId} {
      allow read: if isWhitelisted();
      // 作成: Cloud Functionsのみ（サービスアカウント経由、ルール適用外）
      allow create: if false;
      // 更新: 許可されたフィールドのみ
      allow update: if isWhitelisted()
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          // 顧客解決フィールド（Phase 7）
          'customerId',
          'customerName',
          'customerKey',
          'customerConfirmed',
          'needsManualCustomerSelection',
          'confirmedBy',
          'confirmedAt',
          'isDuplicateCustomer',
          // 事業所解決フィールド
          'officeId',
          'officeName',
          'officeKey',
          'officeConfirmed',
          'officeConfirmedBy',
          'officeConfirmedAt',
          // OCR結果編集フィールド
          'documentType',
          'documentTypeKey',
          'careManagerKey',
          'fileDate',
          'fileName',
          'editedBy',
          'editedAt',
          'updatedAt'
        ])
        // confirmedBy は自分のUIDのみ設定可能（事業所解決時は含まれない場合あり）
        && (request.resource.data.confirmedBy == request.auth.uid
            || request.resource.data.confirmedBy == resource.data.confirmedBy
            || request.resource.data.confirmedBy == null
            || !('confirmedBy' in request.resource.data))
        // officeConfirmedBy は自分のUIDのみ設定可能
        && (request.resource.data.officeConfirmedBy == request.auth.uid
            || request.resource.data.officeConfirmedBy == resource.data.officeConfirmedBy
            || request.resource.data.officeConfirmedBy == null
            || !('officeConfirmedBy' in request.resource.data))
        // editedBy は自分のUIDのみ設定可能
        && (request.resource.data.editedBy == request.auth.uid
            || request.resource.data.editedBy == resource.data.editedBy
            || request.resource.data.editedBy == null
            || !('editedBy' in request.resource.data));
      allow delete: if isAdmin();
    }

    // 顧客解決監査ログ（Phase 7）
    match /customerResolutionLogs/{logId} {
      allow read: if isWhitelisted();
      // 作成: 認証済みユーザー、必須フィールドチェック
      allow create: if isWhitelisted()
        && request.resource.data.resolvedBy == request.auth.uid
        && request.resource.data.documentId is string
        && request.resource.data.documentId.size() > 0
        // newCustomerIdはstringまたはnull（該当なし選択時）
        && (request.resource.data.newCustomerId == null || request.resource.data.newCustomerId is string)
        && request.resource.data.newCustomerName is string
        && request.resource.data.newCustomerName.size() > 0
        && request.resource.data.resolvedByEmail is string
        && request.resource.data.resolvedAt is timestamp;
      // 更新・削除は禁止（監査ログは不変）
      allow update, delete: if false;
    }

    // 事業所解決監査ログ
    match /officeResolutionLogs/{logId} {
      allow read: if isWhitelisted();
      // 作成: 認証済みユーザー、必須フィールドチェック
      allow create: if isWhitelisted()
        && request.resource.data.resolvedBy == request.auth.uid
        && request.resource.data.documentId is string
        && request.resource.data.documentId.size() > 0
        // newOfficeIdはstringまたはnull（該当なし選択時）
        && (request.resource.data.newOfficeId == null || request.resource.data.newOfficeId is string)
        && request.resource.data.newOfficeName is string
        && request.resource.data.newOfficeName.size() > 0
        && request.resource.data.resolvedByEmail is string;
        // resolvedAtはserverTimestamp()で設定されるため、検証はスキップ
      // 更新・削除は禁止（監査ログは不変）
      allow update, delete: if false;
    }

    // ドキュメント編集監査ログ
    match /editLogs/{logId} {
      allow read: if isWhitelisted();
      // 作成: 認証済みユーザー、必須フィールドチェック
      allow create: if isWhitelisted()
        && request.resource.data.editedBy == request.auth.uid
        && request.resource.data.documentId is string
        && request.resource.data.documentId.size() > 0
        && request.resource.data.fieldName is string
        && request.resource.data.fieldName.size() > 0
        && request.resource.data.editedByEmail is string;
      // 更新・削除は禁止（監査ログは不変）
      allow update, delete: if false;
    }

    // マスターデータ
    match /masters/{masterId}/items/{itemId} {
      allow read: if isWhitelisted();
      allow write: if isAdmin();
    }

    // エラー履歴
    match /errors/{errorId} {
      allow read: if isWhitelisted();
      allow write: if isAdmin();
    }

    // Gmail受信ログ
    match /gmailLogs/{logId} {
      allow read: if isWhitelisted();
      allow write: if false; // Cloud Functionsのみ
    }

    // ユーザー管理
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // 自分自身のドキュメント作成を許可（ドメイン許可リストによる自動登録用）
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow read, write: if isAdmin();
    }

    // アプリ設定
    match /settings/{settingId} {
      // settings/authは認証済みユーザーなら読める（ドメイン許可チェック用）
      // 新規ドメインユーザーがusersコレクションに未登録の状態でallowedDomainsを確認する必要があるため
      allow read: if settingId == 'auth' && isAuthenticated();
      // その他の設定はホワイトリスト登録済みユーザーのみ
      allow read: if settingId != 'auth' && isWhitelisted();
      allow write: if isAdmin();
    }

    // Phase 8: ドキュメントグループ（サマリー集計）
    match /documentGroups/{groupId} {
      allow read: if isWhitelisted();
      // 書き込みはCloud Functionsのみ（onDocumentWriteトリガー）
      allow write: if false;
    }

    // 検索インデックス
    match /search_index/{tokenId} {
      allow read: if isWhitelisted();
      // 書き込みはCloud Functionsのみ（onDocumentWriteSearchIndexトリガー）
      allow write: if false;
    }

    // 検索マイグレーション状態
    match /_migrations/{migrationId} {
      allow read: if isAdmin();
      // 書き込みはCloud Functions/管理スクリプトのみ
      allow write: if false;
    }

    // エイリアス学習履歴
    match /aliasLearningLogs/{logId} {
      allow read: if isWhitelisted();
      // 書き込みはCloud Functions（addMasterAlias）のみ
      allow write: if false;
    }

    // アップロードログ
    match /uploadLogs/{logId} {
      allow read: if isWhitelisted();
      // 書き込みはCloud Functions（uploadPdf）のみ
      allow write: if false;
    }
  }
}
