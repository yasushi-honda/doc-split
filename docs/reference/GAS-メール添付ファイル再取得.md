[メールの添付ファイルから再取得](https://drive.google.com/open?id=1fI1XRv_xk4-BV_FtJlspoX7ibezcWjnDtBRkIDR8rCqrUAq1UqDe5biI&usp=drive_copy)

# Gmail添付ファイル リカバリースクリプト \- 技術ドキュメント

## 目次

1. [概要](#1-概要)  
2. [機能詳細](#2-機能詳細)  
3. [関数リファレンス](#3-関数リファレンス)  
4. [実行手順](#4-実行手順)  
5. [ログ出力](#5-ログ出力)  
6. [トラブルシューティング](#6-トラブルシューティング)  
7. [制限事項](#7-制限事項)

---

## 1\. 概要

### 1.1 このスクリプトの目的

このGoogle Apps Scriptは、**メイン処理でエラーとなったファイルをリカバリーするための専用ツール**です。

**位置づけ**:

- メイン処理: 通常の添付ファイル自動保存（別のGAS）  
- このスクリプト: エラーファイルのリカバリー専用（一時的な実行）

### 1.2 リカバリーの仕組み

```
メイン処理でエラー発生
        ↓
エラーファイルがエラーフォルダに蓄積
        ↓
このリカバリースクリプトを実行
        ↓
1. エラーフォルダ内の該当ファイルを削除
2. Gmailから添付ファイルを再取得
3. 正常なフォルダへ保存
```

### 1.3 使用タイミング

- メイン処理でエラーが発生したファイルを再処理する必要がある時  
- エラーフォルダに溜まったファイルをクリーンアップする時  
- 手動でのリカバリー作業が必要な時

**注意**: このスクリプトは常時実行するものではなく、必要に応じて手動で実行する一時的なツールです。

---

## 2\. 機能詳細

### 2.1 エラーファイルの削除

#### 機能

エラーフォルダ内で、指定されたファイル名と完全一致するファイルを検索し、すべてゴミ箱へ移動します。

#### 処理内容

```javascript
// エラーフォルダ内を検索
const filesInErrorFolder = errorFolder.getFilesByName(fileName);

// 見つかったファイルをすべてゴミ箱へ移動
while (filesInErrorFolder.hasNext()) {
  const fileToTrash = filesInErrorFolder.next();
  fileToTrash.setTrashed(true);
}
```

#### 特徴

- ファイル名の完全一致検索  
- 同名ファイルが複数ある場合、すべて削除  
- 削除件数をログに出力

---

### 2.2 メールからの添付ファイル検索

#### 機能

Gmail内から、指定された件名とファイル名を持つメールを検索します。

#### 検索クエリの構築

```
subject:"メール件名" filename:"ファイル名" in:anywhere
```

| 要素 | 説明 |
| :---- | :---- |
| `subject:"..."` | メール件名の完全一致検索 |
| `filename:"..."` | 添付ファイル名の完全一致検索 |
| `in:anywhere` | 全メールボックスを検索（受信トレイ、アーカイブ、迷惑メール、ゴミ箱を含む） |

#### 検索の特徴

- **完全一致**: 部分一致ではなく完全一致で検索  
- **複数条件**: 件名とファイル名の両方が一致するメールのみ抽出  
- **全範囲検索**: メールの保存場所に関わらず検索  
- **サーバーサイド処理**: Googleサーバー側で高速に検索を実行

#### 検索結果の処理

- 検索結果が0件の場合: エラーを出力して処理終了  
- 検索結果が1件の場合: そのメールを処理  
- 検索結果が2件以上の場合: 警告を出力し、最初の1件を処理

---

### 2.3 添付ファイルの抽出

#### 機能

検索で見つかったメール内の全添付ファイルから、指定されたファイル名と完全一致するファイルのみを抽出します。

#### 処理ロジック

```javascript
// メール内の全添付ファイルを取得
const attachments = message.getAttachments();

// ファイル名が完全一致するものだけを処理
for (const attachment of attachments) {
  if (attachment.getName() === fileName) {
    // このファイルを保存
  }
}
```

#### 特徴

- メールに複数の添付ファイルがある場合でも、指定されたファイルのみを抽出  
- ファイル名の完全一致チェック（拡張子を含む）  
- 一致しないファイルは無視

---

### 2.4 ファイルの保存

#### 機能

抽出した添付ファイルを、指定されたGoogleドライブフォルダへ保存します。

#### 処理内容

```javascript
const savedFile = folder.createFile(attachment);
```

#### 保存結果の出力

- 保存されたファイル名  
- 保存先フォルダ名  
- ファイルのURL（クリックして確認可能）

---

### 2.5 エラーハンドリング

#### 対応するエラー

| エラーの種類 | 検出タイミング | 処理 |
| :---- | :---- | :---- |
| パラメータ不足 | 関数実行時 | エラーログを出力して `false` を返す |
| フォルダID不正 | フォルダ取得時 | エラーログを出力して `false` を返す |
| メール未検出 | Gmail検索後 | エラーログを出力して `false` を返す |
| 添付ファイル不一致 | ファイル抽出時 | エラーログを出力して `false` を返す |
| 実行時エラー | 処理中 | 詳細なエラー情報を出力して `false` を返す |

#### エラー出力形式

すべてのエラーは以下の形式で出力されます：

```
【エラー】エラーの説明
```

致命的なエラーの場合：

```
【致命的なエラー】処理中に予期せぬエラーが発生しました: エラーメッセージ
  [詳細] スタックトレース
```

---

## 3\. 関数リファレンス

### 3.1 saveAttachmentToDrive()

#### 概要

エラーファイルをリカバリーするメイン関数です。

#### 構文

```javascript
saveAttachmentToDrive(folderId, errorFolderId, fileName, emailSubject)
```

#### パラメータ

| 引数名 | 型 | 必須 | 説明 |
| :---- | :---- | :---: | :---- |
| `folderId` | string | ✓ | ファイルを保存するGoogleドライブのフォルダID |
| `errorFolderId` | string | ✓ | エラーファイルが保存されているGoogleドライブのフォルダID |
| `fileName` | string | ✓ | リカバリー対象の添付ファイル名（拡張子を含む） |
| `emailSubject` | string | ✓ | 添付ファイルが含まれるメールの件名 |

#### 戻り値

- **型**: `boolean`  
- `true`: リカバリー処理が成功  
- `false`: リカバリー処理が失敗

#### 処理フロー

1. パラメータの検証  
2. 保存先フォルダとエラーフォルダの取得  
3. エラーフォルダ内の同名ファイルをゴミ箱へ移動  
4. Gmail検索クエリの構築  
5. メールの検索  
6. 検索結果の判定  
7. 添付ファイルの抽出  
8. ファイルの保存

---

## 4\. 実行手順

### 4.1 事前準備

#### 必要な情報

1. **保存先フォルダID**: リカバリー後のファイルを保存するフォルダ  
2. **エラーフォルダID**: エラーファイルが保存されているフォルダ  
3. **ファイル名**: リカバリー対象のファイル名（完全一致）  
4. **メール件名**: 添付ファイルが含まれるメールの件名（完全一致）

#### フォルダIDの確認方法

1. Googleドライブで対象フォルダを開く  
2. ブラウザのアドレスバーからURLをコピー  
3. URL内の `folders/` の後ろの文字列がフォルダID

```
https://drive.google.com/drive/folders/【フォルダID】
```

---

### 4.2 スクリプトの実行

#### Apps Scriptエディタから実行

1. Apps Scriptエディタを開く  
2. 関数内のパラメータを設定  
3. 関数を選択して「▶ 実行」をクリック  
4. 実行ログで結果を確認

#### 他のスクリプトから呼び出し

```javascript
function recoverFile() {
  const result = saveAttachmentToDrive(
    "保存先フォルダID",
    "エラーフォルダID",
    "ファイル名.pdf",
    "メール件名"
  );
  
  if (result) {
    console.log("リカバリー成功");
  } else {
    console.log("リカバリー失敗");
  }
}
```

---

## 5\. ログ出力

### 5.1 成功時のログ

```
============================================================
 Gmail添付ファイルのドライブ保存処理を開始します
============================================================
【処理パラメータ】
  保存先フォルダID: 1Z3iATGpHqPi51ZYXpvcanOdFq9pu8yjI
  エラーフォルダID: 1A2bCdEfGhIjKlMnOpQrStUvWxYz12345
  ファイル名: error_file.pdf
  メール件名: 書類送付
------------------------------------------------------------
  [OK] 保存先フォルダ「保存先」を認識しました。
  [OK] エラーフォルダ「エラー」を認識しました。
  [削除] エラーフォルダ内のファイル「error_file.pdf」をゴミ箱に移動しました。
    ファイルID: 1XyZaBcDeFgHiJkLmNoPqRsTuVwXyZ123
  [完了] 1 件のファイルをゴミ箱に移動しました。
------------------------------------------------------------
  [検索クエリ] → subject:"書類送付" filename:"error_file.pdf" in:anywhere
  [検索結果] → 1 件のスレッドがヒットしました。最初のスレッドを処理します。
------------------------------------------------------------
★★★ 処理成功 ★★★
  ファイルを「保存先」フォルダに保存しました。
  保存ファイル名: error_file.pdf
  ファイルURL: https://drive.google.com/file/d/1AbCdEfGhIjKlMnOpQrStUvWxYz/view
============================================================
```

### 5.2 エラーフォルダにファイルがない場合

```
  [確認] エラーフォルダ内に「file.pdf」は見つかりませんでした。
```

このログが出力されても処理は続行され、メールからの取得のみが実行されます。

---

### 5.3 エラー時のログ

#### パラメータ不足

```
【エラー】folderId, errorFolderId, fileName, emailSubject のいずれかの引数が不足しています。
```

#### メール未検出

```
  [検索クエリ] → subject:"件名" filename:"file.pdf" in:anywhere
【エラー】条件に一致するメールが見つかりませんでした。件名やファイル名が正確か確認してください。
```

#### 添付ファイル不一致

```
  [検索結果] → 1 件のスレッドがヒットしました。最初のスレッドを処理します。
【エラー】メールは見つかりましたが、指定されたファイル名の添付ファイルが含まれていませんでした。
```

#### フォルダID不正

```
【致命的なエラー】処理中に予期せぬエラーが発生しました: Exception: Unexpected error while getting the method or property getFolderById on object DriveApp.
```

#### 複数メール検出（警告）

```
【警告】条件に一致するメールが複数見つかりました。最初の1件を処理しますが、意図しないファイルを取得する可能性があります。
```

---

## 6\. トラブルシューティング

### 6.1 メールが見つからない

**原因**:

- 件名またはファイル名が完全一致していない  
- メールが存在しない

**確認方法**:

1. Gmailの検索ボックスで手動検索

```
subject:"完全な件名" filename:"完全なファイル名"
```

2. メールが見つかる場合、件名とファイル名を正確にコピー  
3. スペース、全角/半角、記号なども完全に一致させる

---

### 6.2 添付ファイルが見つからない

**原因**:

- メールは見つかったが、指定されたファイル名の添付ファイルがない  
- ファイル名が完全一致していない

**確認方法**:

1. メールを開いて添付ファイルの正確な名前を確認  
2. 拡張子も含めて完全に一致させる

---

### 6.3 フォルダIDエラー

**原因**:

- フォルダIDが間違っている  
- フォルダへのアクセス権限がない  
- フォルダが削除されている

**確認方法**:

1. Googleドライブで対象フォルダを開く  
2. URLから正しいフォルダIDを再度コピー  
3. フォルダへのアクセス権限を確認

---

### 6.4 複数のメールがヒットする

**原因**:

- 同じ件名とファイル名の組み合わせを持つメールが複数存在

**対処法**:

- より具体的な件名を指定する（日付や時刻を含む）  
- 不要な古いメールを削除する  
- 最初にヒットしたメールが処理されるため、保存されたファイルが意図したものか確認する

---

### 6.5 エラーメッセージ一覧

| エラーメッセージ | 原因 | 対処法 |
| :---- | :---- | :---- |
| 引数が不足しています | パラメータ不足 | 4つの引数すべてを指定 |
| メールが見つかりませんでした | メール未検出 | 件名とファイル名を完全一致で指定 |
| 添付ファイルが含まれていませんでした | 添付ファイル不一致 | ファイル名を正確に指定（拡張子含む） |
| getFolderById エラー | フォルダID不正 | フォルダIDとアクセス権限を確認 |

---

## 7\. 制限事項

### 7.1 Gmail API制限

- 1日あたり: 25,000件のメール処理  
- 100秒間あたり: 250件のメール処理

### 7.2 Drive API制限

- 1日あたり: 1,000,000,000クォータユニット  
- 100秒間あたり: 10,000クォータユニット

### 7.3 検索仕様

- 件名とファイル名は完全一致のみ（部分一致不可）  
- スレッド内の最初のメッセージのみが処理対象  
- メールに複数の添付ファイルがある場合、指定されたファイル名のもののみ保存

### 7.4 ファイルサイズ

- Gmailの添付ファイル上限: 25MB  
- それ以上はGoogleドライブリンクとして送信される（このスクリプトでは処理不可）

### 7.5 実行時間

- Google Apps Scriptの実行時間制限: 最大6分

### 7.6 ゴミ箱

- ゴミ箱に移動したファイルは30日後に自動的に完全削除される  
- 手動で復元可能（Googleドライブのゴミ箱から）

---

## 補足

### このスクリプトの位置づけ

このスクリプトは、メイン処理システムの補助ツールとして機能します。

**通常のワークフロー**:

```
メール受信 → メイン処理（自動） → 成功 → 正常フォルダへ保存
                              → 失敗 → エラーフォルダへ保存
```

**リカバリーワークフロー**:

```
エラーフォルダにファイルが蓄積
         ↓
このスクリプトを手動実行
         ↓
エラーファイル削除 → メールから再取得 → 正常フォルダへ保存
```

このスクリプトは、エラーが発生した際の**リカバリー専用の一時ツール**として使用します。  
