# DocSplit 管理者ガイド

## 管理者機能

管理者（role: admin）は以下の追加機能にアクセスできます：

- 設定画面
- マスターデータ管理
- ユーザー管理

## 設定画面

### Gmail設定

| 項目 | 説明 |
|---|---|
| 監視ラベル | 監視対象のGmailラベル（複数指定可） |
| ラベル条件 | AND（全ラベル一致）/ OR（いずれかのラベル） |
| 監視アカウント | 監視対象のGmailアドレス |

### ユーザー管理

ログインを許可するユーザーをホワイトリストで管理します。

**ユーザー追加:**
1. 「ユーザー追加」をクリック
2. Googleアカウントのメールアドレスを入力
3. ロール（admin / user）を選択
4. 「追加」をクリック

**ユーザー削除:**
1. 一覧から対象ユーザーの「削除」をクリック
2. 確認ダイアログで「削除」をクリック

### 通知設定

エラー発生時の通知先メールアドレスを設定します。

### セットアップ情報

テナントの初期設定情報を確認できます（読み取り専用）。

| 項目 | 説明 |
|---|---|
| プロジェクトID | Firebase/GCPプロジェクトID |
| セットアップ日時 | 初期セットアップの実行日時 |
| 初期管理者 | セットアップ時に設定した管理者メール |
| Gmail監視アカウント | 監視対象のGmailアカウント |
| アプリURL | アプリのURL |

※各項目にコピーボタンがあり、問い合わせ時などに便利です。

## マスターデータ管理

### 顧客マスター

| フィールド | 説明 |
|---|---|
| 名前 | 顧客名 |
| ふりがな | 検索用のふりがな |
| 担当ケアマネ | 担当のケアマネジャー |
| 許容表記（エイリアス） | OCRマッチングで認識する別表記 |

**許容表記（エイリアス）について:**
- 「山田太郎」と「やまだ太郎」（漢字↔ひらがな）など、正規化で吸収できない表記ゆれを登録
- 確定時に「この表記を記憶する」にチェックすると自動追加
- マスター管理画面の追加・編集ダイアログからも直接登録可能
- CSV一括インポートの `aliases` 列でも登録可能（`|` 区切り）
- 一度登録すると、次回から同じ表記がOCRで自動マッチ（スコア98）
- テーブルビューの「許容表記」列で登録済みエイリアスを一覧確認可能

> 詳細は [表記ゆれ対応（エイリアス学習）](../alias-feature.md) を参照してください。

### 書類マスター

| フィールド | 説明 |
|---|---|
| 書類名 | 書類の種類名 |
| 日付マーカー | 日付を探す際の目印（例: "発行日"） |
| カテゴリ | 分類用のカテゴリ |
| 許容表記（エイリアス） | OCRマッチングで認識する別表記 |

### 事業所マスター

| フィールド | 説明 |
|---|---|
| 名前 | 事業所名 |
| 許容表記（エイリアス） | OCRマッチングで認識する別表記 |

**エイリアス（許容表記）の管理:**
- 追加・編集ダイアログの「許容表記」欄にカンマまたは `|` 区切りで入力
- CSV一括インポート時は `aliases` 列に `|` 区切りで指定
- テーブルの「許容表記」列で登録状況を確認可能

**同名事業所について:**
- 支店名など同じ名前の事業所がある場合、OCR処理で候補として表示
- ユーザーが手動で正しい事業所を選択

### ケアマネマスター

| フィールド | 説明 |
|---|---|
| 名前 | ケアマネジャー名 |

## 自動処理スケジュール

Cloud Functionsによる自動処理のスケジュール：

| 関数 | 間隔 | 説明 |
|------|------|------|
| checkGmailAttachments | 5分 | Gmailから新着添付ファイルを取得 |
| processOCR | 1分 | 処理待ち書類のOCR実行 |

※processOCRは1分間隔で実行されるため、書類アップロード後1〜2分でOCR処理が完了します。

## 監視・トラブルシューティング

### エラー分類

エラーは自動的に以下のカテゴリに分類され、`errors`コレクションに記録されます。

#### 発生源（Source）

| 発生源 | 説明 | 主な原因 |
|--------|------|---------|
| gmail | Gmail取得処理 | OAuth認証エラー、API制限 |
| ocr | OCR処理 | Gemini APIエラー、レート制限 |
| pdf | PDF操作 | ファイル破損、分割/回転失敗 |
| storage | ファイル保存 | 権限エラー、容量超過 |
| auth | 認証処理 | 権限不足、トークン期限切れ |

#### カテゴリと重要度

| カテゴリ | 重要度 | 説明 | 対処 |
|---------|--------|------|------|
| transient | warning | 一時的エラー（ネットワーク等） | 自動リトライ |
| recoverable | warning | 回復可能エラー | 再処理で解決 |
| data | error | データ品質問題 | ファイル確認・再アップロード |
| fatal | critical | 致命的エラー | システム管理者に連絡 |

#### エラー履歴の確認

アプリ内「エラー履歴」画面で確認できます。各エラーには以下の情報が含まれます：
- 発生日時
- 発生源・カテゴリ
- エラーメッセージ
- 対象ドキュメント（ある場合）

### ログの確認

**Firebase Console:**
```
https://console.firebase.google.com/project/doc-split-dev/functions/logs
```

**GCP Console:**
```
https://console.cloud.google.com/logs/query?project=doc-split-dev
```

### よくあるエラー

#### Gmail API エラー

```
error_type: gmail_fetch_failed
```

**原因:**
- OAuth トークンの期限切れ
- Gmail API のクォータ超過
- ネットワークエラー

**対処:**
1. Cloud Functions のログを確認
2. Secret Manager の認証情報を更新（必要な場合）
3. Gmail API のクォータを確認

#### OCR エラー

```
error_type: ocr_failed
```

**原因:**
- Gemini API のレート制限
- 画像品質の問題
- PDFの破損

**対処:**
1. 書類一覧画面の「再処理」ボタンから一括再AI OCR処理を実行（下記「一括操作」セクション参照）
2. レート制限の場合は時間をおいて再試行
3. PDFが破損している場合は手動で対応

#### ドキュメントが「処理中」のまま進まない

**症状:** ドキュメントが `processing`（処理中）のまま長時間停滞し、「再処理」ボタンも表示されない。

**原因:** OCR処理中の内部エラーでステータスが `error` に遷移できなかったケース（2026-02-07修正済み）。

**対処:**
```bash
# 1. 状況確認（変更なし）
FIREBASE_PROJECT_ID=<project-id> node scripts/fix-stuck-documents.js --dry-run

# 2. pendingにリセット（OCRポーリングが自動で再処理）
FIREBASE_PROJECT_ID=<project-id> node scripts/fix-stuck-documents.js
```

#### マッチング失敗

```
error_type: matching_failed
```

**原因:**
- マスターデータに該当がない
- OCR結果の精度が低い
- 類似度が閾値（70%）未満

**対処:**
1. マスターデータを確認・追加
2. 書類詳細から手動で修正

### 一括操作（削除・確認済み・再処理）

書類一覧画面の上部に、管理者専用の一括操作ボタンが常時表示されています。

#### 操作手順

| ステップ | 操作 |
|---------|------|
| 1 | 実行したい操作のボタン（再処理 / 確認済み / 削除）をクリック |
| 2 | 選択モードが開始され、各書類にチェックボックスが表示される |
| 3 | 対象の書類にチェックを入れる（複数選択可） |
| 4 | 同じボタンをもう一度クリックして実行（ボタンの色が変わります） |

選択モードを解除するには、デスクトップでは×ボタン、モバイルでは同じボタンを再度クリックします。

#### 各操作の説明

| 操作 | 内容 | 用途 |
|------|------|------|
| **再処理** | AI OCRを再実行 | OCRエラーの書類、精度が低い書類の再読み取り |
| **確認済み** | 書類を確認済みとしてマーク | 内容を目視確認した書類の記録 |
| **削除** | 書類を完全に削除 | 不要な書類、重複書類の整理 |

#### ボタンの状態

- **枠線のみ（通常）**: クリックで選択モードを開始
- **薄い背景色**: 選択モード中（書類を選んでください）
- **塗りつぶし**: 1件以上選択済み（クリックで実行）

### Gemini API コスト監視

日次のAPI使用量は Firestore の `/stats/gemini/daily` に記録されます。

確認方法:
```javascript
// Firestore Console から確認
/stats/gemini/daily/{YYYY-MM-DD}
{
  inputTokens: number,
  outputTokens: number,
  totalRequests: number,
  estimatedCost: number
}
```

### 定期メンテナンス

**クライアント管理者向け（アプリ内で実施）:**
- 週次: エラー履歴の確認・対応
- 随時: マスターデータの追加・更新
- 随時: ユーザーの追加・削除

**システム管理者向け（開発者が実施）:**
- 月次: Gemini API コストの確認（GCP Console）
- 月次: Storage 使用量の確認（Firebase Console）

## 緊急時対応

### Functions の停止

```bash
# すべての Functions を無効化
firebase functions:config:set maintenance.enabled=true
firebase deploy --only functions
```

### データのバックアップ

```bash
# Firestore エクスポート
gcloud firestore export gs://doc-split-dev-backups/$(date +%Y%m%d)
```

### ロールバック

```bash
# 前バージョンへのロールバック
firebase hosting:rollback

# Functions は自動ロールバック不可（再デプロイが必要）
```
