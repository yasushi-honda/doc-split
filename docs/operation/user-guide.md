# DocSplit ユーザーガイド

## 概要

DocSplitは、Gmailに届く書類（PDF）を自動的に取得し、AI OCRでメタ情報を抽出・管理するアプリケーションです。

### 自動処理のタイミング

- **Gmail取得**: 5分ごとに新着メールをチェック
- **OCR処理**: 1分ごとに処理待ち書類を処理

書類をアップロード後、通常1〜2分以内にOCR処理が完了します。

## ログイン

1. `https://doc-split-dev.web.app` にアクセス
2. 「Googleでログイン」ボタンをクリック
3. 許可されたGoogleアカウントでログイン

※ログインできるのは管理者が許可したアカウントのみです。

## 書類一覧画面

### 統計情報

画面上部に以下の統計が表示されます：

- **総書類数**: 登録されている書類の総数
- **処理待ち**: OCR処理待ちの書類数
- **処理中**: 現在OCR処理中の書類数
- **完了**: 処理が完了した書類数
- **エラー**: 処理でエラーが発生した書類数

### タブ切替

書類一覧は以下のタブで表示を切り替えられます：

| タブ | 説明 |
|---|---|
| 書類一覧 | 全書類を一覧表示 |
| 顧客別 | 顧客ごとにグループ化 |
| 事業所別 | 事業所ごとにグループ化 |
| 書類種別 | 書類タイプごとにグループ化 |
| 担当CM別 | 担当ケアマネごとにグループ化 |
| 確認待ち | 顧客/事業所の確定が必要な書類 |

### 検索・フィルター

- **検索バー**: 顧客名、書類名、事業所名、OCRテキストで全文検索
- **ステータスフィルター**: 全て / 処理待ち / 処理中 / 完了 / エラー
- **日付フィルター**: 作成日の範囲で絞り込み

### 書類一覧

書類は以下の情報が表示されます：

| 列 | 説明 |
|---|---|
| 書類名 | 書類の種類 |
| 顧客名 | 関連する顧客 |
| 事業所 | 関連する事業所 |
| 書類日 | 書類の日付 |
| ステータス | 処理状態（バッジ表示） |
| 作成日 | 取得日時 |

行をクリックすると書類詳細が表示されます。

## 書類詳細画面

### PDFビューアー

- 左側にPDFが表示されます
- ページ送り: 「前へ」「次へ」ボタン
- 拡大・縮小: ツールバーのボタン
- 全画面表示: 拡大ボタン

### PDF回転の永続保存

スキャン時に向きが間違っているPDFを修正できます：

1. 「回転」ボタンをクリック（90度ずつ回転）
2. 回転後、「保存」ボタンが表示される
3. 以下のいずれかを選択：
   - **全ページに適用して保存**: 全ページを同じ角度で回転
   - **このページのみ保存**: 現在のページのみ回転
4. 保存後、次回以降も回転が適用された状態で表示

※回転はPDFファイル自体に保存されるため、ダウンロードしても回転が維持されます。

### メタ情報

右側のサイドバーに以下が表示されます：

- 顧客名
- 書類タイプ
- 事業所
- 書類日
- ステータス
- 作成日時

### PDF分割（管理者のみ）

複数ページのPDFを分割する場合：

1. 「分割」ボタンをクリック
2. 「自動検出」で分割ポイントを検出（検出結果がメッセージで表示されます）
3. 必要に応じて分割点を追加/削除
4. 各セグメントのメタ情報を編集
5. 「分割実行」をクリック

※自動検出は、書類種別マスターに登録されたキーワードを元に分割ポイントを判定します。

## PDFアップロード

### ローカルファイルのアップロード

書類一覧画面の「アップロード」ボタンからPDFファイルをアップロードできます。

1. 「アップロード」ボタンをクリック
2. ファイルを選択（またはドラッグ＆ドロップ）
3. アップロード後、自動的にOCR処理が開始されます

### 重複ファイルの取り扱い

同じファイル名の書類がすでに存在する場合、確認ダイアログが表示されます：

- **上書き**: 既存の書類を置き換えてアップロード
- **別名で保存**: 自動生成された別名（例: `文書_2.pdf`）で保存

※分割元のファイルは重複チェックの対象外です。分割後に元ファイルを再アップロードする場合、別ファイルとして登録されます。

## 確認待ち対応

### 同姓同名・同名の解決

OCR処理で顧客名や事業所名が複数の候補に一致した場合、確認待ちになります。

**対応手順:**
1. 「確認待ち」タブを開く（またはバナーをクリック）
2. 対象の書類をクリック
3. 候補一覧から正しい顧客/事業所を選択
4. 「この表記を記憶する」にチェックを入れると、次回から同じ表記が自動マッチ
5. 「確定」をクリック

**該当なしの場合:**
- 「該当なし」を選択すると、新規マスター登録を提案されます
- 登録後、自動的に書類に紐付けられます

## 処理履歴画面

### 概要

最近処理された書類を時系列で確認できます。

### フィルター

- **期間**: 今日 / 過去7日 / 過去30日 / 全期間
- **ステータス**: 全て / 完了 / エラー
- **顧客確定**: 全て / 確定済み / 未確定

## エラー履歴画面

OCR処理でエラーが発生した書類を確認できます。

### 統計情報

- **総エラー数**: 発生したエラーの総数
- **未対応**: まだ対応していないエラー
- **対応中**: 現在対応中のエラー
- **完了**: 対応が完了したエラー

### フィルター

- **ステータス**: 未対応 / 対応中 / 完了
- **エラー種別**: OCR失敗 / ファイル取得失敗 / マッチング失敗 など

### アクション

- **再処理**: エラーとなった書類のOCRを再実行
- **完了**: エラーを手動で解決済みとしてマーク

## よくある質問

### Q: 書類が表示されない
A: 以下を確認してください：
- Gmail設定が正しいか（設定画面）
- 対象のGmailラベルが設定されているか
- 検索フィルターがかかっていないか

### Q: OCRが正しく認識されない
A: 以下の場合は認識精度が低下します：
- 画像が不鮮明
- 傾きや歪みがある
- 手書き文字

### Q: 間違った顧客名が割り当てられた
A: 書類詳細から手動で修正できます（管理者権限が必要）。
